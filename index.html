<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multi-Period Stock Dashboard v2 (Trend + Volume)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Mini charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Lightweight Charts for big chart -->
  <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root {
      --bg: #020617;
      --bg-soft: #0b1120;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #3b82f6;
      --up: #4ade80;
      --down: #f97373;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 45%);
      color: var(--text);
    }
    .app {
      max-width: 1400px;
      margin: 0 auto;
    }
    .header {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-end;
      margin-bottom: 10px;
    }
    .title {
      font-size: 1.4rem;
      font-weight: 600;
    }
    .subtitle {
      font-size: 0.85rem;
      color: var(--muted);
    }
    .status {
      margin-left: auto;
      font-size: 0.8rem;
      color: var(--muted);
      text-align: right;
    }

    .controls {
      margin-bottom: 12px;
      padding: 8px;
      border-radius: 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .controls label {
      font-size: 0.78rem;
      color: var(--muted);
    }
    .controls input,
    .controls select,
    .controls button {
      font-family: inherit;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 10px;
      background: #020617;
      color: var(--text);
      outline: none;
    }
    .controls input:focus,
    .controls select:focus {
      border-color: var(--accent);
    }
    .controls button {
      cursor: pointer;
      background: linear-gradient(to right, #2563eb, #4f46e5);
      border: none;
      color: white;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .controls button:hover {
      filter: brightness(1.08);
    }
    .badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .sectors {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    details.sector {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.95);
      overflow: hidden;
    }
    details[open].sector {
      box-shadow: 0 16px 40px rgba(0,0,0,0.5);
    }
    details > summary {
      list-style: none;
      cursor: pointer;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to right, rgba(15,23,42,0.95), rgba(30,64,175,0.45));
    }
    details > summary::-webkit-details-marker { display: none; }
    .sector-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .sector-name {
      font-size: 0.9rem;
      font-weight: 600;
    }
    .sector-meta {
      font-size: 0.7rem;
      color: var(--muted);
    }
    .sector-toggle {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .sector-body {
      padding: 8px 8px 10px;
      background: #020617;
    }

    .sector-tools {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-bottom: 4px;
    }
    .sector-tools .sort-btn {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--muted);
      cursor: pointer;
    }
    .sector-tools .sort-btn:hover {
      border-color: var(--accent);
      color: #e5e7eb;
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
      font-size: 0.78rem;
    }
    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid #111827;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background: #020617;
      color: var(--muted);
      font-weight: 500;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th.stock-col {
      min-width: 90px;
    }
    td.symbol-cell {
      text-align: left;
    }
    .symbol-click {
      font-weight: 600;
      font-size: 0.85rem;
      color: #bfdbfe;
      cursor: pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
      text-underline-offset: 3px;
    }
    .symbol-click:hover {
      color: #e0f2fe;
    }
    .name {
      font-size: 0.7rem;
      color: var(--muted);
    }
    .remove-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-size: 0.7rem;
      padding: 0 4px;
      border-radius: 999px;
      margin-left: 4px;
    }
    .remove-btn:hover {
      background: rgba(148,163,184,0.1);
      color: #fecaca;
    }

    .cell-chart {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .cell-chart canvas {
      width: 120px !important;
      height: 40px !important;
    }
    .change-text {
      font-size: 0.7rem;
    }
    .change-up {
      color: var(--up);
      font-weight: 500;
    }
    .change-down {
      color: var(--down);
      font-weight: 500;
    }
    .change-flat {
      color: var(--muted);
    }

    .pos-cell {
      min-width: 170px;
    }
    .pos-container {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .pos-row {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .pos-label {
      font-size: 0.65rem;
      color: var(--muted);
      width: 2.4em;
    }
    .pos-bar {
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: #0f172a;
      overflow: hidden;
    }
    .pos-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(to right, #f97373, #4ade80);
    }
    .pos-val {
      font-size: 0.65rem;
      color: var(--muted);
      width: 3em;
      text-align: right;
    }

    .buy-cell {
      min-width: 90px;
    }
    .buy-score {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      border: 1px solid transparent;
    }
    .buy-strong {
      background: rgba(34,197,94,0.15);
      color: #6ee7b7;
      border-color: rgba(34,197,94,0.7);
    }
    .buy-good {
      background: rgba(59,130,246,0.15);
      color: #bfdbfe;
      border-color: rgba(59,130,246,0.7);
    }
    .buy-neutral {
      background: rgba(148,163,184,0.15);
      color: #e5e7eb;
      border-color: rgba(148,163,184,0.7);
    }
    .buy-weak {
      background: rgba(249,115,22,0.15);
      color: #fed7aa;
      border-color: rgba(249,115,22,0.7);
    }
    .buy-bad {
      background: rgba(248,113,113,0.15);
      color: #fecaca;
      border-color: rgba(248,113,113,0.7);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-overlay.show {
      display: flex;
    }
    .modal-card {
      background: #020617;
      border-radius: 16px;
      border: 1px solid #1f2937;
      width: 90%;
      max-width: 900px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      padding: 12px;
      box-shadow: 0 25px 60px rgba(0,0,0,0.7);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }
    .modal-title {
      font-size: 1rem;
      font-weight: 600;
    }
    .modal-subtitle {
      font-size: 0.75rem;
      color: var(--muted);
    }
    .modal-header-right {
      display:flex;
      gap:6px;
      align-items:center;
    }
    .modal-close-btn,
    .modal-download-btn {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      background: #111827;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .modal-close-btn:hover,
    .modal-download-btn:hover {
      background: #1f2937;
    }
    .modal-body {
      flex: 1;
      min-height: 300px;
      display:flex;
      flex-direction:column;
    }
    #timeframe-buttons {
      margin-bottom:8px;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .tf-btn {
      border-radius:999px;
      border:1px solid #1f2937;
      background:#020617;
      color:#9ca3af;
      font-size:0.75rem;
      padding:3px 8px;
      cursor:pointer;
    }
    .tf-btn.active {
      background:#1d4ed8;
      color:#e5e7eb;
      border-color:#3b82f6;
    }

    #big-chart-container {
      flex:1;
      border-radius:8px;
      border:1px solid #1f2937;
      background:#020617;
      overflow:hidden;
    }

    @media (max-width: 768px) {
      .header { flex-direction: column; align-items: flex-start; }
      .status { margin-left: 0; text-align: left; }
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      .controls > div {
        display: flex;
        justify-content: space-between;
        gap: 6px;
      }
      .controls input,
      .controls select {
        flex: 1;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <div>
      <div classtitle>Multi-Period Stock Dashboard v2</div>
      <div class="subtitle">
        Sectors ¬∑ 1Y / 6M / 3M / 1M / 1W / 1D mini charts ¬∑ BuyScore v2 (Position + Trend + Accel + Vol + MACD) ¬∑ filter & sorting ¬∑ big trend chart (area + MA20/60 + volume)
      </div>
    </div>
    <div class="status">
      <div id="status-text">Initializing...</div>
      <div style="font-size:0.7rem;">Refresh: <span id="refresh-sec">30</span>s ¬∑ Cache: 5 min</div>
    </div>
  </div>

  <div class="controls">
    <div>
      <label for="symbol-input">Ticker</label>
      <input id="symbol-input" placeholder="e.g. MSFT / NVDA / 0700.HK" />
    </div>
    <div>
      <label for="sector-select">Sector</label>
      <select id="sector-select"></select>
    </div>
    <div id="custom-sector-wrap" style="display:none;">
      <label for="custom-sector-input">New sector</label>
      <input id="custom-sector-input" placeholder="e.g. Crypto / Energy" />
    </div>
    <div>
      <button id="add-btn">‚ûï Add stock</button>
    </div>
    <div style="margin-left:auto;">
      <span class="badge">üì¶ Local cache &nbsp;|&nbsp; üîÅ Auto-refresh 30s</span>
    </div>
  </div>

  <div class="controls" style="margin-top:6px;">
    <button id="expand-all">‚¨Ü Expand all sectors</button>
    <button id="collapse-all">‚¨á Collapse all sectors</button>
    <label style="display:flex;align-items:center;gap:4px;font-size:0.8rem;color:var(--muted);margin-left:auto;">
      <input type="checkbox" id="filter-strong" />
      Only show BuyScore ‚â• 80
    </label>
  </div>

  <div id="sectors" class="sectors"></div>
</div>

<div id="chart-modal" class="modal-overlay">
  <div class="modal-card" onclick="event.stopPropagation();">
    <div class="modal-header">
      <div>
        <div id="modal-title" class="modal-title"></div>
        <div id="modal-subtitle" class="modal-subtitle"></div>
      </div>
      <div class="modal-header-right">
        <button id="download-png" class="modal-download-btn">‚¨á PNG</button>
        <button id="modal-close" class="modal-close-btn">‚úï Close</button>
      </div>
    </div>
    <div class="modal-body">
      <div id="timeframe-buttons">
        <button class="tf-btn" data-range="1d"  data-int="1m"  data-key="1m">1m</button>
        <button class="tf-btn" data-range="5d"  data-int="15m" data-key="15m">15m</button>
        <button class="tf-btn" data-range="1mo" data-int="1h"  data-key="1h">1h</button>
        <button class="tf-btn" data-range="3mo" data-int="1d"  data-key="1D">1D</button>
        <button class="tf-btn" data-range="6mo" data-int="1d"  data-key="6M">6M</button>
        <button class="tf-btn" data-range="1y"  data-int="1wk" data-key="1Y">1Y</button>
        <button class="tf-btn" data-range="3y"  data-int="1wk" data-key="3Y">3Y</button>
        <button class="tf-btn" data-range="max" data-int="1wk" data-key="MAX">MAX</button>
      </div>
      <div id="big-chart-container" style="width:100%;height:100%;"></div>
    </div>
  </div>
</div>

<script>
  const REFRESH_MS = 30000;
  const CACHE_TTL_MS = 5 * 60_000;
  const STORAGE_SECTORS = "multi_period_sectors_trend_v2";
  const STORAGE_CACHE   = "multi_period_cache_trend_v2";
  document.getElementById("refresh-sec").textContent = REFRESH_MS / 1000;

  // ==== Êñ∞ÁöÑËØÑÂàÜÂë®ÊúüÔºö1Y / 6M / 3M / 1M / 1W / 1D ====
  const PERIODS = [
    { key: "1Y", label: "1Y", range: "1y",   interval: "1wk" },
    { key: "6M", label: "6M", range: "6mo",  interval: "1d"  },
    { key: "3M", label: "3M", range: "3mo",  interval: "1d"  },
    { key: "1M", label: "1M", range: "1mo",  interval: "1d"  },
    { key: "1W", label: "1W", range: "1mo",  interval: "1d"  },
    { key: "1D", label: "1D", range: "5d",   interval: "1h"  },
  ];

  // Position Âè™Â±ïÁ§∫‰∏≠ÈïøÊúü+ÈÉ®ÂàÜÁü≠Êúü
  const POSITION_PERIODS = ["1Y","6M","3M","1M","1W"];

  const defaultSectors = [
    {
      name: "Technology",
      stocks: [
        { symbol: "MSFT", name: "Microsoft" },
        { symbol: "ORCL", name: "Oracle" },
        { symbol: "PLTR", name: "Palantir" },
      ],
    },
    {
      name: "Semiconductor",
      stocks: [
        { symbol: "NVDA", name: "NVIDIA" },
        { symbol: "AVGO", name: "Broadcom" },
        { symbol: "AMD",  name: "AMD" },
        { symbol: "MU",   name: "Micron" },
        { symbol: "QCOM", name: "Qualcomm" },
        { symbol: "INTC", name: "Intel" },
        { symbol: "ASML", name: "ASML" },
        { symbol: "TSM",  name: "TSMC" },
        { symbol: "SMCI", name: "Super Micro Computer" },
      ],
    },
    {
      name: "Consumer",
      stocks: [
        { symbol: "AMZN", name: "Amazon" },
        { symbol: "TSLA", name: "Tesla" },
        { symbol: "KO",   name: "Coca-Cola" },
        { symbol: "PEP",  name: "PepsiCo" },
      ],
    },
    {
      name: "Internet",
      stocks: [
        { symbol: "GOOGL", name: "Alphabet (Google)" },
        { symbol: "META",  name: "Meta" },
        { symbol: "NFLX",  name: "Netflix" },
      ],
    },
    {
      name: "Europe",
      stocks: [
        { symbol: "RHM.DE",  name: "Rheinmetall" },
        { symbol: "SIE.DE",  name: "Siemens" },
        { symbol: "ENR.DE",  name: "Siemens Energy" },
        { symbol: "SHL.DE",  name: "Siemens Healthineers" },
        { symbol: "MBG.DE",  name: "Mercedes-Benz" },
        { symbol: "BMW.DE",  name: "BMW" },
        { symbol: "VOW3.DE", name: "Volkswagen" },
        { symbol: "CON.DE",  name: "Continental" },
        { symbol: "DAST.PA", name: "Dassault Syst√®mes" },
        { symbol: "SAF.PA",  name: "Safran" },
        { symbol: "AIR.PA",  name: "Airbus" },
        { symbol: "ARM",     name: "ARM Holdings" },
        { symbol: "KTR.DE",  name: "Kontron" },
      ],
    },
    {
      name: "China",
      stocks: [
        { symbol: "1211.HK",   name: "BYD" },
        { symbol: "1810.HK",   name: "Xiaomi" },
        { symbol: "BABA",      name: "Alibaba" },
        { symbol: "BIDU",      name: "Baidu" },
        { symbol: "0700.HK",   name: "Tencent" },
        { symbol: "300750.SZ", name: "CATL" },
        { symbol: "9992.HK",   name: "Pop Mart" },
      ],
    },
    {
      name: "Other",
      stocks: [
        { symbol: "IREN", name: "Iris Energy" },
        { symbol: "BE",   name: "Bloom Energy" },
        { symbol: "CCJ",  name: "Cameco" },
        { symbol: "JBL",  name: "Jabil" },
        { symbol: "SNPS", name: "Synopsys" },
        { symbol: "CLS",  name: "Celestica" },
      ],
    },
  ];

  let sectors = [];
  const charts = {};
  const PROXY = "https://corsproxy.io/?url=";

  let lwChart = null;
  let areaSeries = null;
  let ma20Series = null;
  let ma60Series = null;
  let volumeSeries = null;
  let currentBigSymbol = null;
  let currentBigName = null;
  let bigChartResizeObserver = null;

  // ---------- ÂÆâÂÖ®Â∑•ÂÖ∑ÂáΩÊï∞ ----------
  function loadCache() {
    try { return JSON.parse(localStorage.getItem(STORAGE_CACHE) || "{}"); }
    catch { return {}; }
  }
  function saveCache(obj) {
    try { localStorage.setItem(STORAGE_CACHE, JSON.stringify(obj)); }
    catch {}
  }

  function safeGetYahooResult(json) {
    const r = json?.chart?.result;
    if (!r || !Array.isArray(r) || r.length === 0) return null;
    return r[0];
  }

  async function fetchYahoo(symbol, range, interval) {
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?range=${range}&interval=${interval}`;
    const fullUrl = PROXY + encodeURIComponent(url);

    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        const res = await fetch(fullUrl);
        const text = await res.text();
        let json = null;
        try {
          json = JSON.parse(text);
        } catch {
          console.warn("Non-JSON from proxy for", symbol, range, interval);
          return null;
        }
        if (json?.chart?.error) {
          console.warn("Yahoo error:", symbol, json.chart.error);
          return null;
        }
        return json;
      } catch (e) {
        console.warn(`fetchYahoo error [${symbol}] attempt ${attempt}`, e);
        if (attempt === 3) return null;
      }
    }
    return null;
  }

  async function getSeries(symbol, periodKey) {
    const cache = loadCache();
    const cacheKey = `${symbol}_${periodKey}`;
    const now = Date.now();

    if (cache[cacheKey] && now - cache[cacheKey].ts < CACHE_TTL_MS) {
      return cache[cacheKey].series || null;
    }
    const cfg = PERIODS.find(p => p.key === periodKey);
    if (!cfg) return null;

    try {
      const json = await fetchYahoo(symbol, cfg.range, cfg.interval);
      if (!json) return null;
      const result = safeGetYahooResult(json);
      if (!result) return null;

      const closes = result?.indicators?.quote?.[0]?.close || [];
      const filtered = (closes || []).filter(v => v != null);
      if (!filtered || filtered.length < 2) {
        return null;
      }
      cache[cacheKey] = { ts: now, series: filtered };
      saveCache(cache);
      return filtered;
    } catch (e) {
      console.error("getSeries error", symbol, periodKey, e);
      return null;
    }
  }

  function percentChange(series) {
    if (!series || series.length < 2) return null;
    const a = series[0];
    const b = series[series.length - 1];
    if (a == null || b == null || a === 0) return null;
    const val = ((b - a) / a) * 100;
    if (!Number.isFinite(val)) return null;
    return Number(val.toFixed(2));
  }

  function positionPercent(series) {
    if (!series || series.length < 2) return null;
    const min = Math.min(...series);
    const max = Math.max(...series);
    const last = series[series.length - 1];
    if (!Number.isFinite(min) || !Number.isFinite(max) || !Number.isFinite(last)) {
      return null;
    }
    if (max <= min) return 50;
    const val = ((last - min) / (max - min)) * 100;
    if (!Number.isFinite(val)) return null;
    return val;
  }

  // ===== ËØÑÂàÜÂáΩÊï∞‰ª¨ =====

  // PositionScoreÔºöÁúã 1Y / 6M / 3M ÁöÑÁõ∏ÂØπÈ´ò‰Ωé‰ΩçÔºàË∂ä‰æøÂÆúÂàÜË∂äÈ´òÔºâ
  function computePositionScore(seriesPerPeriod) {
    const p1Y = positionPercent(seriesPerPeriod["1Y"]);
    const p6M = positionPercent(seriesPerPeriod["6M"]);
    const p3M = positionPercent(seriesPerPeriod["3M"]);
    const _p1 = Number.isFinite(p1Y) ? p1Y : 50;
    const _p6 = Number.isFinite(p6M) ? p6M : 50;
    const _p3 = Number.isFinite(p3M) ? p3M : 50;
    const posWeighted = 0.40*_p1 + 0.35*_p6 + 0.25*_p3;
    let posScore = (1 - posWeighted/100)*100;
    if (!Number.isFinite(posScore)) posScore = 50;
    return Math.max(0, Math.min(100, posScore));
  }

  // TrendScoreÔºö1Y / 6M / 3M / 1M / 1W / 1D Âä†ÊùÉÊ∂®ÂπÖ
  function computeTrendScore(pctMap) {
    const d1Y = pctMap["1Y"] ?? 0;
    const d6M = pctMap["6M"] ?? 0;
    const d3M = pctMap["3M"] ?? 0;
    const d1M = pctMap["1M"] ?? 0;
    const d1W = pctMap["1W"] ?? 0;
    const d1D = pctMap["1D"] ?? 0;

    const weighted =
      0.15*d1Y +
      0.30*d6M +
      0.25*d3M +
      0.15*d1M +
      0.10*d1W +
      0.05*d1D;

    let score = 50 + weighted*1.2;
    if (!Number.isFinite(score)) score = 50;
    return Math.max(0, Math.min(100, score));
  }

  // AccelerationScoreÔºöË∂ãÂäøÂèòÂåñÊòØÂê¶Âú®ÂèòÂ•ΩÔºàÂ§öÂë®ÊúüÊñúÁéáÂ∑ÆÔºâ
  function computeAccelerationScore(pctMap) {
    const d1Y = pctMap["1Y"] ?? 0;
    const d6M = pctMap["6M"] ?? 0;
    const d3M = pctMap["3M"] ?? 0;
    const d1M = pctMap["1M"] ?? 0;
    const d1W = pctMap["1W"] ?? 0;

    const acc1 = d1W - d1M;
    const acc2 = d1M - d3M;
    const acc3 = d3M - d6M;
    const acc4 = d6M - d1Y;
    const accs = [acc1,acc2,acc3,acc4];
    const pos = accs.filter(a=>a>0).length;
    const neg = accs.filter(a=>a<0).length;
    const consistency = (pos - neg)/4;
    const avgAccel = accs.reduce((a,b)=>a+b,0)/4;
    let score = 50 + consistency*30 + avgAccel*1.5;
    if (!Number.isFinite(score)) score = 50;
    return Math.max(0, Math.min(100, score));
  }

  // VolatilityScoreÔºö6M Êó•Ê≥¢Âä®ÁéáÔºåË∂äÁ®≥ÂàÜË∂äÈ´ò
  function computeVolatilityScore(series6M) {
    if (!Array.isArray(series6M) || series6M.length < 10) return 50;

    const returns = [];
    for (let i = 1; i < series6M.length; i++) {
      const p0 = series6M[i-1];
      const p1 = series6M[i];
      if (p0 != null && p1 != null && p0 > 0 && p1 > 0) {
        returns.push(Math.log(p1 / p0));
      }
    }
    if (returns.length < 5) return 50;

    const mean = returns.reduce((a,b)=>a+b,0) / returns.length;
    let varSum = 0;
    for (const r of returns) {
      varSum += (r - mean) * (r - mean);
    }
    const variance = varSum / (returns.length - 1);
    if (!Number.isFinite(variance) || variance <= 0) return 70;

    const vol = Math.sqrt(variance); // Êó•Ê≥¢Âä®Áéá
    const maxVol = 0.05; // 5% ÂΩì‰ΩúÊûÅÈôê
    const v = Math.min(vol, maxVol) / maxVol; // 0~1

    // 0% ‚Üí 100 ÂàÜ,  5% ‚Üí 20 ÂàÜ
    let score = 100 - v * 80;
    if (!Number.isFinite(score)) score = 50;
    return Math.max(0, Math.min(100, score));
  }

  // EMA Â∑•ÂÖ∑ + MACDScoreÔºà6M Êó•Á∫ø MACDÔºâ
  function ema(arr, period) {
    const k = 2 / (period + 1);
    const out = [];
    let prev = null;
    for (let i = 0; i < arr.length; i++) {
      const price = arr[i];
      if (price == null) continue;
      if (prev == null) {
        prev = price;
      } else {
        prev = price * k + prev * (1 - k);
      }
      out.push(prev);
    }
    return out;
  }

  function computeMACDScore(series6M) {
    if (!Array.isArray(series6M) || series6M.length < 35) return 50;

    const closes = series6M.filter(v => v != null);
    if (closes.length < 35) return 50;

    const ema12 = ema(closes, 12);
    const ema26 = ema(closes, 26);

    const macdLine = [];
    for (let i = 0; i < ema26.length; i++) {
      const idx = i + (closes.length - ema26.length);
      const e12 = ema12[idx];
      const e26 = ema26[i];
      if (e12 != null && e26 != null) {
        macdLine.push(e12 - e26);
      }
    }
    if (macdLine.length < 10) return 50;

    const signal = ema(macdLine, 9);
    const hist = macdLine[macdLine.length - 1] - signal[signal.length - 1];

    const lastClose = closes[closes.length - 1];
    if (!lastClose || !Number.isFinite(hist)) return 50;

    const ratio = hist / lastClose;
    let x = ratio * 100; // ÁôæÂàÜÊØî
    x = Math.max(-5, Math.min(5, x)); // ÈôêÂà∂Âú® [-5, +5]

    // -5% ‚Üí 0 ÂàÜÔºõ 0% ‚Üí 50 ÂàÜÔºõ +5% ‚Üí 100 ÂàÜ
    let score = 50 + x * 10;
    if (!Number.isFinite(score)) score = 50;
    return Math.max(0, Math.min(100, score));
  }

  // BuyScore 2.xÔºöPosition + Trend + Accel + Vol + MACD
  function computeBuyScore(seriesPerPeriod, pctMap) {
    const hasValidSeries = Object.values(seriesPerPeriod).some(
      s => Array.isArray(s) && s.length >= 2
    );
    if (!hasValidSeries) {
      return {
        buyScore: null,
        posScore: null,
        trendScore: null,
        accelScore: null,
        volScore: null,
        macdScore: null,
      };
    }

    const posScore   = computePositionScore(seriesPerPeriod);
    const trendScore = computeTrendScore(pctMap);
    const accelScore = computeAccelerationScore(pctMap);

    const series6M = seriesPerPeriod["6M"];
    const volScore  = computeVolatilityScore(series6M);
    const macdScore = computeMACDScore(series6M);

    let buy =
      0.28*posScore +
      0.32*trendScore +
      0.20*accelScore +
      0.10*volScore +
      0.10*macdScore;

    if (!Number.isFinite(buy)) buy = 50;
    buy = Math.max(0, Math.min(100, buy));

    return {
      buyScore: Math.round(buy),
      posScore,
      trendScore,
      accelScore,
      volScore,
      macdScore
    };
  }

  function loadSectors() {
    try {
      const raw = localStorage.getItem(STORAGE_SECTORS);
      if (raw) sectors = JSON.parse(raw);
      else sectors = defaultSectors;
    } catch {
      sectors = defaultSectors;
    }
  }
  function saveSectors() {
    try { localStorage.setItem(STORAGE_SECTORS, JSON.stringify(sectors)); }
    catch {}
  }

  function renderSectorSelect() {
    const select = document.getElementById("sector-select");
    select.innerHTML = "";
    sectors.forEach(sec => {
      const opt = document.createElement("option");
      opt.value = sec.name;
      opt.textContent = sec.name;
      select.appendChild(opt);
    });
    const optCustom = document.createElement("option");
    optCustom.value = "__custom__";
    optCustom.textContent = "‚ûï New sector...";
    select.appendChild(optCustom);
  }

  function renderSectors() {
    const container = document.getElementById("sectors");
    container.innerHTML = "";
    sectors.forEach(sec => {
      const details = document.createElement("details");
      details.className = "sector";
      details.open = true;
      details.dataset.sectorName = sec.name;

      const summary = document.createElement("summary");
      const left = document.createElement("div");
      left.className = "sector-title";
      const nameEl = document.createElement("div");
      nameEl.className = "sector-name";
      nameEl.textContent = sec.name;
      const metaEl = document.createElement("div");
      metaEl.className = "sector-meta";
      metaEl.textContent = `${sec.stocks.length} stocks`;
      left.appendChild(nameEl);
      left.appendChild(metaEl);

      const right = document.createElement("div");
      right.className = "sector-toggle";
      right.textContent = "Click to collapse / expand";

      summary.appendChild(left);
      summary.appendChild(right);
      details.appendChild(summary);

      const body = document.createElement("div");
      body.className = "sector-body";

      const tools = document.createElement("div");
      tools.className = "sector-tools";
      tools.innerHTML = `
        <button class="sort-btn" data-sector="${sec.name}" data-dir="desc">Sort by BuyScore ‚Üì</button>
        <button class="sort-btn" data-sector="${sec.name}" data-dir="asc">Sort by BuyScore ‚Üë</button>
      `;
      body.appendChild(tools);

      const wrapper = document.createElement("div");
      wrapper.className = "table-wrapper";

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const trHead = document.createElement("tr");
      trHead.innerHTML = `
        <th class="stock-col">Symbol</th>
        ${PERIODS.map(p => `<th>${p.label} trend</th>`).join("")}
        <th>Position</th>
        <th>BuyScore</th>
      `;
      thead.appendChild(trHead);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      sec.stocks.forEach(stock => {
        const tr = document.createElement("tr");
        tr.dataset.symbol = stock.symbol;
        tr.dataset.sector = sec.name;

        const tdSymbol = document.createElement("td");
        tdSymbol.className = "symbol-cell";
        tdSymbol.innerHTML = `
          <div class="symbol-click" data-symbol="${stock.symbol}" data-name="${stock.name || ""}">
            ${stock.symbol}
          </div>
          <div class="name">${stock.name || ""}</div>
        `;
        const removeBtn = document.createElement("button");
        removeBtn.className = "remove-btn";
        removeBtn.textContent = "Del";
        removeBtn.title = `Remove ${stock.symbol} from ${sec.name}`;
        removeBtn.dataset.symbol = stock.symbol;
        removeBtn.dataset.sector = sec.name;
        tdSymbol.appendChild(removeBtn);
        tr.appendChild(tdSymbol);

        PERIODS.forEach(p => {
          const td = document.createElement("td");
          const cell = document.createElement("div");
          cell.className = "cell-chart";

          const canvas = document.createElement("canvas");
          canvas.id = `${stock.symbol}_${p.key}`;
          canvas.width = 120;
          canvas.height = 40;

          const changeDiv = document.createElement("div");
          changeDiv.id = `${stock.symbol}_${p.key}_change`;
          changeDiv.className = "change-text change-flat";
          changeDiv.textContent = "--";

          cell.appendChild(canvas);
          cell.appendChild(changeDiv);
          td.appendChild(cell);
          tr.appendChild(td);
        });

        const tdPos = document.createElement("td");
        tdPos.className = "pos-cell";
        const posContainer = document.createElement("div");
        posContainer.className = "pos-container";
        posContainer.id = `${stock.symbol}_pos`;
        tdPos.appendChild(posContainer);
        tr.appendChild(tdPos);

        const tdBuy = document.createElement("td");
        tdBuy.className = "buy-cell";
        const buySpan = document.createElement("span");
        buySpan.id = `${stock.symbol}_buyscore`;
        buySpan.className = "buy-score buy-neutral";
        buySpan.textContent = "--";
        tdBuy.appendChild(buySpan);
        tr.appendChild(tdBuy);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      wrapper.appendChild(table);
      body.appendChild(wrapper);
      details.appendChild(body);
      container.appendChild(details);
    });
  }

  function drawSpark(symbol, periodKey, series) {
    const canvas = document.getElementById(`${symbol}_${periodKey}`);
    if (!canvas || !series || series.length < 2) return;
    const ctx = canvas.getContext("2d");
    const trimmed = series.slice(-40);
    const up = trimmed[trimmed.length - 1] >= trimmed[0];

    const gradient = ctx.createLinearGradient(0,0,0,canvas.height);
    if (up) {
      gradient.addColorStop(0,"rgba(74,222,128,0.8)");
      gradient.addColorStop(1,"rgba(22,163,74,0.05)");
    } else {
      gradient.addColorStop(0,"rgba(248,113,113,0.8)");
      gradient.addColorStop(1,"rgba(127,29,29,0.05)");
    }

    const chartKey = `${symbol}_${periodKey}`;
    if (charts[chartKey]) charts[chartKey].destroy();

    charts[chartKey] = new Chart(ctx,{
      type:"line",
      data:{
        labels:trimmed.map((_,i)=>i),
        datasets:[{
          data:trimmed,
          borderColor: up ? "#4ade80" : "#f97373",
          backgroundColor: gradient,
          fill:true,
          tension:0.35,
          borderWidth:1.4,
          pointRadius:0,
        }]
      },
      options:{
        responsive:false,
        maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{enabled:false} },
        scales:{ x:{display:false}, y:{display:false} }
      }
    });
  }

  function renderPositionCell(symbol, seriesPerPeriod) {
    const container = document.getElementById(`${symbol}_pos`);
    if (!container) return;
    let html = "";
    POSITION_PERIODS.forEach(key=>{
      const s = seriesPerPeriod[key];
      let pos = positionPercent(s);
      let txt = "--";
      let width = 0;
      if (Number.isFinite(pos)) {
        const clamped = Math.max(0,Math.min(100,pos));
        width = Math.max(4,Math.round(clamped));
        txt = Math.round(clamped)+"%";
      }
      html += `
        <div class="pos-row">
          <span class="pos-label">${key}</span>
          <div class="pos-bar">
            <div class="pos-fill" style="width:${width}%;"></div>
          </div>
          <span class="pos-val">${txt}</span>
        </div>
      `;
    });
    container.innerHTML = html;
  }

  function renderBuyScore(symbol, buyScore, posScore, trendScore, accelScore, volScore, macdScore) {
    const el = document.getElementById(`${symbol}_buyscore`);
    if (!el) return;
    if (buyScore == null || Number.isNaN(buyScore)) {
      el.textContent = "--";
      el.className = "buy-score buy-neutral";
      el.title = "Not enough data";
      return;
    }
    let cls = "buy-score ";
    if (buyScore >= 80) cls += "buy-strong";
    else if (buyScore >= 60) cls += "buy-good";
    else if (buyScore >= 40) cls += "buy-neutral";
    else if (buyScore >= 20) cls += "buy-weak";
    else cls += "buy-bad";
    el.className = cls;
    el.textContent = String(buyScore);
    el.title =
      `Position:     ${Math.round(posScore)}\n` +
      `Trend:        ${Math.round(trendScore)}\n` +
      `Acceleration: ${Math.round(accelScore)}\n` +
      `Volatility:   ${Math.round(volScore)}\n` +
      `MACD:         ${Math.round(macdScore)}\n` +
      `BuyScore v2:  ${buyScore}`;
  }

  function applyFilters() {
    const chk = document.getElementById("filter-strong");
    const active = chk && chk.checked;
    const rows = document.querySelectorAll("tr[data-symbol]");
    rows.forEach(row=>{
      if (!active) {
        row.style.display = "";
      } else {
        const scoreStr = row.dataset.buyscore;
        const score = scoreStr ? parseInt(scoreStr,10) : null;
        if (score != null && score >= 80) row.style.display = "";
        else row.style.display = "none";
      }
    });
  }

  function sortSectorByBuyScore(sectorName, dir) {
    const details = document.querySelector(`details.sector[data-sector-name="${sectorName}"]`);
    if (!details) return;
    const tbody = details.querySelector("tbody");
    if (!tbody) return;
    const rows = Array.from(tbody.querySelectorAll("tr[data-symbol]"));
    rows.sort((a,b)=>{
      const sa = parseInt(a.dataset.buyscore || "0",10);
      const sb = parseInt(b.dataset.buyscore || "0",10);
      if (Number.isNaN(sa)) return 1;
      if (Number.isNaN(sb)) return -1;
      return dir === "asc" ? sa - sb : sb - sa;
    });
    rows.forEach(r=>tbody.appendChild(r));
  }

  function attachBigChartResizeObserver() {
    const container = document.getElementById("big-chart-container");
    if (!container) return;

    if (bigChartResizeObserver) {
      bigChartResizeObserver.disconnect();
      bigChartResizeObserver = null;
    }

    bigChartResizeObserver = new ResizeObserver(entries => {
      for (let entry of entries) {
        if (lwChart) {
          const { width, height } = entry.contentRect;
          if (width > 10 && height > 10) {
            lwChart.resize(width, height);
          }
        }
      }
    });

    bigChartResizeObserver.observe(container);
  }

  function computeMAForLine(data, windowSize) {
    const out = [];
    let sum = 0;
    for (let i = 0; i < data.length; i++) {
      sum += data[i].value;
      if (i >= windowSize) sum -= data[i - windowSize].value;
      if (i >= windowSize - 1) {
        out.push({
          time: data[i].time,
          value: sum / windowSize,
        });
      }
    }
    return out;
  }

  async function drawBigChart(symbol, range, interval) {
    const container = document.getElementById("big-chart-container");
    if (!container) return;

    const { clientWidth: w, clientHeight: h } = container;
    if (w < 20 || h < 20) {
      console.warn("Container not ready, retry drawBigChart...");
      return setTimeout(() => drawBigChart(symbol, range, interval), 80);
    }

    container.innerHTML = "";
    if (lwChart) {
      lwChart.remove();
      lwChart = null;
      areaSeries = null;
      ma20Series = null;
      ma60Series = null;
      volumeSeries = null;
    }

    lwChart = LightweightCharts.createChart(container, {
      width: w,
      height: h,
      layout: {
        background: { type: 'solid', color: '#020617' },
        textColor: '#e5e7eb',
      },
      grid: {
        vertLines: { color: '#111827' },
        horzLines: { color: '#111827' },
      },
      timeScale: { borderColor: '#1f2937' },
      rightPriceScale: { borderColor: '#1f2937' },
    });

    areaSeries = lwChart.addAreaSeries({
      lineColor: '#3b82f6',
      topColor: 'rgba(59,130,246,0.45)',
      bottomColor: 'rgba(15,23,42,0.0)',
      lineWidth: 2,
    });

    volumeSeries = lwChart.addHistogramSeries({
      priceScaleId: 'volume',
      priceFormat: { type: 'volume' },
      scaleMargins: { top: 0.8, bottom: 0 },
    });
    lwChart.priceScale('volume').applyOptions({
      scaleMargins: { top: 0.8, bottom: 0 },
    });

    try {
      const json = await fetchYahoo(symbol, range, interval);
      if (!json) {
        console.warn("No data for big chart", symbol);
        return;
      }
      const result = safeGetYahooResult(json);
      if (!result) {
        console.warn("No result in big chart", symbol);
        return;
      }

      const ts = result?.timestamp || [];
      const q = result?.indicators?.quote?.[0] || {};
      const closes = q.close || [];
      const vols = q.volume || [];

      const lineData = [];
      const volData  = [];

      for (let i = 0; i < ts.length; i++) {
        if (closes[i] == null) continue;
        const time = ts[i];

        lineData.push({
          time,
          value: closes[i],
        });

        const prev = i > 0 && closes[i-1] != null ? closes[i-1] : closes[i];
        volData.push({
          time,
          value: vols[i] ?? 0,
          color: closes[i] >= prev
            ? "rgba(74,222,128,0.5)"
            : "rgba(248,113,113,0.5)",
        });
      }

      if (!lineData.length) {
        console.warn("No line data for big chart", symbol);
        return;
      }

      areaSeries.setData(lineData);
      volumeSeries.setData(volData);

      const ma20 = computeMAForLine(lineData, 20);
      const ma60 = computeMAForLine(lineData, 60);

      ma20Series = lwChart.addLineSeries({
        color: "#38bdf8",
        lineWidth: 1.2,
      });
      ma20Series.setData(ma20);

      ma60Series = lwChart.addLineSeries({
        color: "#fbbf24",
        lineWidth: 1.2,
      });
      ma60Series.setData(ma60);

      lwChart.timeScale().fitContent();
    } catch (e) {
      console.error("Big chart error:", e);
    }
  }

  function highlightTimeframeButton(key) {
    document.querySelectorAll(".tf-btn").forEach(btn=>{
      if (btn.dataset.key === key) btn.classList.add("active");
      else btn.classList.remove("active");
    });
  }

  function openBigChart(symbol, name) {
    currentBigSymbol = symbol;
    currentBigName = name || "";
    const modal = document.getElementById("chart-modal");
    modal.classList.add("show");

    document.getElementById("modal-title").textContent = symbol;
    document.getElementById("modal-subtitle").textContent = currentBigName;

    const btnDefault = document.querySelector('.tf-btn[data-key="3Y"]');
    const range = btnDefault.dataset.range;
    const interval = btnDefault.dataset.int;
    highlightTimeframeButton("3Y");

    setTimeout(() => {
      drawBigChart(symbol, range, interval);
      attachBigChartResizeObserver();
    }, 150);

    document.querySelectorAll(".tf-btn").forEach(btn => {
      btn.onclick = () => {
        const r = btn.dataset.range;
        const it = btn.dataset.int;
        const key = btn.dataset.key;
        highlightTimeframeButton(key);
        setTimeout(() => {
          drawBigChart(symbol, r, it);
          attachBigChartResizeObserver();
        }, 120);
      };
    });
  }

  function closeBigChart() {
    const modal = document.getElementById("chart-modal");
    modal.classList.remove("show");
    if (bigChartResizeObserver) {
      bigChartResizeObserver.disconnect();
      bigChartResizeObserver = null;
    }
    if (lwChart) {
      lwChart.remove();
      lwChart = null;
      areaSeries = null;
      ma20Series = null;
      ma60Series = null;
      volumeSeries = null;
    }
  }

  function downloadBigChartPng() {
    if (!lwChart || typeof lwChart.takeScreenshot !== "function") {
      alert("Screenshot not supported by this version of Lightweight Charts.");
      return;
    }
    const canvas = lwChart.takeScreenshot();
    if (!canvas || !canvas.toDataURL) {
      alert("Screenshot failed.");
      return;
    }
    const url = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = url;
    a.download = `${currentBigSymbol || "chart"}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  async function refreshAll() {
    const statusEl = document.getElementById("status-text");
    statusEl.textContent = "‚è≥ Refreshing... " + new Date().toLocaleTimeString();

    const allRows = document.querySelectorAll("tr[data-symbol]");
    for (const row of allRows) {
      try {
        const symbol = row.dataset.symbol;
        const seriesPerPeriod = {};
        const pctMap = {};

        for (const p of PERIODS) {
          const changeEl = document.getElementById(`${symbol}_${p.key}_change`);
          try {
            const series = await getSeries(symbol, p.key);
            seriesPerPeriod[p.key] = series;

            let pct = null;
            if (series && series.length >= 2) pct = percentChange(series);
            pctMap[p.key] = pct;

            if (!series || series.length < 2 || pct == null) {
              if (changeEl) {
                changeEl.textContent = "--";
                changeEl.className = "change-text change-flat";
              }
              continue;
            }

            if (changeEl) {
              const sign = pct > 0 ? "+" : "";
              changeEl.textContent = `${sign}${pct}%`;
              changeEl.className =
                "change-text " +
                (pct > 0 ? "change-up" : pct < 0 ? "change-down" : "change-flat");
            }
            drawSpark(symbol, p.key, series);
          } catch (innerErr) {
            console.error("Error per symbol/period", symbol, p.key, innerErr);
            if (changeEl) {
              changeEl.textContent = "Err";
              changeEl.className = "change-text change-down";
            }
          }
        }

        renderPositionCell(symbol, seriesPerPeriod);
        const { buyScore, posScore, trendScore, accelScore, volScore, macdScore } =
          computeBuyScore(seriesPerPeriod, pctMap);
        renderBuyScore(symbol, buyScore, posScore, trendScore, accelScore, volScore, macdScore);
        row.dataset.buyscore = buyScore == null ? "" : String(buyScore);
      } catch (rowErr) {
        console.error("Row-level error", row.dataset.symbol, rowErr);
      }
    }

    applyFilters();
    statusEl.textContent = "‚úî Updated at " + new Date().toLocaleTimeString();
  }

  function addStock() {
    const symbolInput = document.getElementById("symbol-input");
    const sectorSelect = document.getElementById("sector-select");
    const customSectorInput = document.getElementById("custom-sector-input");

    let symbol = symbolInput.value.trim().toUpperCase();
    if (!symbol) return;
    let sectorName = sectorSelect.value;

    if (sectorName === "__custom__") {
      sectorName = customSectorInput.value.trim();
    }
    if (!sectorName) {
      alert("Please enter a sector name.");
      return;
    }

    let sec = sectors.find(s=>s.name===sectorName);
    if (!sec) {
      sec = { name: sectorName, stocks:[] };
      sectors.push(sec);
    }
    if (sec.stocks.some(s=>s.symbol===symbol)) {
      alert("This stock already exists in that sector.");
      return;
    }

    sec.stocks.push({ symbol, name:"" });
    saveSectors();
    renderSectorSelect();
    renderSectors();
    refreshAll();

    symbolInput.value = "";
    if (sectorSelect.value === "__custom__") customSectorInput.value = "";
  }

  function removeStock(symbol, sectorName) {
    const sec = sectors.find(s=>s.name===sectorName);
    if (!sec) return;
    sec.stocks = sec.stocks.filter(s=>s.symbol!==symbol);
    saveSectors();
    renderSectorSelect();
    renderSectors();
    refreshAll();
  }

  function expandAllSectors() {
    document.querySelectorAll("details.sector").forEach(sec=>sec.open=true);
  }
  function collapseAllSectors() {
    document.querySelectorAll("details.sector").forEach(sec=>sec.open=false);
  }

  function setupExpandCollapseButtons() {
    document.getElementById("expand-all").addEventListener("click", expandAllSectors);
    document.getElementById("collapse-all").addEventListener("click", collapseAllSectors);
  }

  function setupEvents() {
    document.getElementById("add-btn").addEventListener("click", addStock);
    document.getElementById("symbol-input").addEventListener("keydown", e=>{
      if (e.key === "Enter") addStock();
    });

    const sectorSelect = document.getElementById("sector-select");
    const customWrap = document.getElementById("custom-sector-wrap");
    sectorSelect.addEventListener("change", ()=>{
      customWrap.style.display = sectorSelect.value==="__custom__" ? "block" : "none";
    });

    document.getElementById("filter-strong").addEventListener("change", applyFilters);

    document.getElementById("sectors").addEventListener("click", e=>{
      const btn = e.target.closest(".remove-btn");
      if (btn) {
        const symbol = btn.dataset.symbol;
        const sector = btn.dataset.sector;
        if (confirm(`Remove ${symbol} from "${sector}"?`)) {
          removeStock(symbol, sector);
        }
        return;
      }
      const sortBtn = e.target.closest(".sort-btn");
      if (sortBtn) {
        const sectorName = sortBtn.dataset.sector;
        const dir = sortBtn.dataset.dir || "desc";
        sortSectorByBuyScore(sectorName, dir);
        return;
      }
      const symEl = e.target.closest(".symbol-click");
      if (symEl) {
        const symbol = symEl.dataset.symbol;
        const name = symEl.dataset.name || "";
        openBigChart(symbol, name);
        e.stopPropagation();
        return;
      }
    });

    const modal = document.getElementById("chart-modal");
    const closeBtn = document.getElementById("modal-close");
    const downloadBtn = document.getElementById("download-png");
    closeBtn.addEventListener("click", ()=>closeBigChart());
    modal.addEventListener("click", ()=>closeBigChart());
    downloadBtn.addEventListener("click", downloadBigChartPng);

    document.addEventListener("keydown", e=>{
      if (e.key === "Escape") closeBigChart();
    });
  }

  (function init(){
    loadSectors();
    renderSectorSelect();
    renderSectors();
    setupEvents();
    setupExpandCollapseButtons();
    refreshAll();
    setInterval(refreshAll, REFRESH_MS);
  })();
</script>
</body>
</html>
